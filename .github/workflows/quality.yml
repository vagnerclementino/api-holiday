name: ğŸ¯ Quality Assurance

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened, ready_for_review ]
  workflow_dispatch:

# Prevent concurrent runs on the same PR
concurrency:
  group: quality-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '24'
  JAVA_DISTRIBUTION: 'corretto'
  MAVEN_OPTS: '-Xmx2048m -XX:MaxMetaspaceSize=512m'

jobs:
  # ============================================================================
  # JOB 1: BUILD & COMPILE
  # ============================================================================
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ğŸ“‹ Validate Maven Configuration
        run: |
          echo "ğŸ” Validating Maven setup..."
          ./mvnw --version
          ./mvnw help:effective-pom -q

      - name: ğŸ—ï¸ Compile Application
        run: |
          echo "ğŸ”¨ Compiling source code..."
          ./mvnw clean compile -DskipTests -B -V

      - name: ğŸ§ª Compile Tests
        run: |
          echo "ğŸ”¨ Compiling test code..."
          ./mvnw test-compile -DskipTests -B -V

      - name: ğŸ“¦ Package Application
        run: |
          echo "ğŸ“¦ Creating JAR package..."
          ./mvnw package -DskipTests -B -V

      - name: ğŸ’¾ Cache Build Artifacts
        uses: actions/cache@v4
        with:
          path: |
            target/
            ~/.m2/repository
          key: build-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}-${{ github.sha }}
          restore-keys: |
            build-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}-
            build-${{ runner.os }}-

      - name: ğŸ“Š Build Summary
        run: |
          echo "âœ… Build completed successfully!"
          echo "ğŸ“¦ JAR Size: $(du -h target/*.jar | cut -f1)"
          echo "ğŸ•’ Build Time: $(date)"

  # ============================================================================
  # JOB 2: CODE STYLE CHECK
  # ============================================================================
  checkstyle:
    name: ğŸ¨ Code Style Check
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ğŸ’¾ Restore Build Cache
        uses: actions/cache@v4
        with:
          path: |
            target/
            ~/.m2/repository
          key: build-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}-${{ github.sha }}
          restore-keys: |
            build-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}-

      - name: ğŸ¨ Run Checkstyle
        run: |
          echo "ğŸ¨ Running Checkstyle analysis..."
          ./mvnw checkstyle:check -B -V

      - name: ğŸ“‹ Format Check (Spotless)
        run: |
          echo "ğŸ“‹ Checking code formatting..."
          ./mvnw spotless:check -B -V

      - name: ğŸ“Š Style Check Summary
        if: always()
        run: |
          echo "ğŸ¨ Code style check completed!"
          if [ -f target/checkstyle-result.xml ]; then
            echo "ğŸ“„ Checkstyle report generated"
          fi

      - name: ğŸ“¤ Upload Checkstyle Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: |
            target/checkstyle-result.xml
            target/site/checkstyle.html
          retention-days: 2

  # ============================================================================
  # JOB 3: UNIT TESTS
  # ============================================================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ğŸ’¾ Restore Build Cache
        uses: actions/cache@v4
        with:
          path: |
            target/
            ~/.m2/repository
          key: build-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}-${{ github.sha }}
          restore-keys: |
            build-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}-

      - name: ğŸ§ª Run Unit Tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          ./mvnw test -Dtest="!**/*IntegrationTest" -B -V

      - name: ğŸ“Š Generate Test Report
        if: always()
        run: |
          echo "ğŸ“Š Generating test reports..."
          ./mvnw surefire-report:report-only -B

      - name: ğŸ“ˆ Test Results Summary
        if: always()
        run: |
          echo "ğŸ“Š Unit Test Results:"
          if [ -f target/surefire-reports/TEST-*.xml ]; then
            echo "âœ… Test reports generated"
            find target/surefire-reports -name "TEST-*.xml" -exec basename {} \; | wc -l | xargs echo "ğŸ“„ Test files:"
          fi

      - name: ğŸ“¤ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            target/surefire-reports/
            target/site/surefire-report.html
          retention-days: 7

      - name: ğŸ“‹ Publish Unit Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: ğŸ§ª Unit Test Results
          path: target/surefire-reports/TEST-*.xml
          reporter: java-junit
          fail-on-error: true

  # ============================================================================
  # JOB 4: INTEGRATION TESTS
  # ============================================================================
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    services:
      mongodb:
        image: mongo:8
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
          MONGO_INITDB_DATABASE: holiday_test
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ğŸ’¾ Restore Build Cache
        uses: actions/cache@v4
        with:
          path: |
            target/
            ~/.m2/repository
          key: build-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}-${{ github.sha }}
          restore-keys: |
            build-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}-

      - name: ğŸ” Verify MongoDB Connection
        run: |
          echo "ğŸ” Testing MongoDB connection..."
          timeout 30 bash -c 'until mongosh --host localhost:27017 --eval "db.runCommand({ping: 1})" --quiet; do sleep 2; done'
          echo "âœ… MongoDB is ready!"

      - name: ğŸ”— Run Integration Tests
        env:
          SPRING_DATA_MONGODB_URI: mongodb://admin:password@localhost:27017/holiday_test?authSource=admin
          SPRING_PROFILES_ACTIVE: test
        run: |
          echo "ğŸ”— Running integration tests..."
          ./mvnw test -Dtest="**/*IntegrationTest" -B -V

      - name: ğŸ“Š Generate Integration Test Report
        if: always()
        run: |
          echo "ğŸ“Š Generating integration test reports..."
          ./mvnw surefire-report:report-only -B

      - name: ğŸ“ˆ Integration Test Results Summary
        if: always()
        run: |
          echo "ğŸ“Š Integration Test Results:"
          if [ -f target/surefire-reports/TEST-*.xml ]; then
            echo "âœ… Integration test reports generated"
            find target/surefire-reports -name "TEST-*IntegrationTest.xml" -exec basename {} \; | wc -l | xargs echo "ğŸ“„ Integration test files:"
          fi

      - name: ğŸ“¤ Upload Integration Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            target/surefire-reports/
            target/site/surefire-report.html
          retention-days: 7

      - name: ğŸ“‹ Publish Integration Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: ğŸ”— Integration Test Results
          path: target/surefire-reports/TEST-*IntegrationTest.xml
          reporter: java-junit
          fail-on-error: true

  # ============================================================================
  # JOB 5: QUALITY GATE
  # ============================================================================
  quality-gate:
    name: ğŸšª Quality Gate
    runs-on: ubuntu-latest
    needs: [build, checkstyle, unit-tests, integration-tests]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ğŸ“Š Check Job Results
        run: |
          echo "ğŸ” Checking all job results..."
          echo "Build: ${{ needs.build.result }}"
          echo "Checkstyle: ${{ needs.checkstyle.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"

      - name: âœ… Quality Gate Passed
        if: |
          needs.build.result == 'success' &&
          needs.checkstyle.result == 'success' &&
          needs.unit-tests.result == 'success' &&
          needs.integration-tests.result == 'success'
        run: |
          echo "ğŸ‰ All quality checks passed!"
          echo "âœ… Build: SUCCESS"
          echo "âœ… Code Style: SUCCESS"
          echo "âœ… Unit Tests: SUCCESS"
          echo "âœ… Integration Tests: SUCCESS"
          echo ""
          echo "ğŸš€ Pull Request is ready for merge!"

      - name: âŒ Quality Gate Failed
        if: |
          needs.build.result != 'success' ||
          needs.checkstyle.result != 'success' ||
          needs.unit-tests.result != 'success' ||
          needs.integration-tests.result != 'success'
        run: |
          echo "âŒ Quality gate failed!"
          echo "Build: ${{ needs.build.result }}"
          echo "Checkstyle: ${{ needs.checkstyle.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo ""
          echo "ğŸš« Pull Request cannot be merged until all checks pass."
          exit 1

      - name: ğŸ“‹ Quality Summary
        if: always()
        run: |
          echo "ğŸ“Š QUALITY ASSURANCE SUMMARY"
          echo "================================"
          echo "ğŸ—ï¸  Build: ${{ needs.build.result }}"
          echo "ğŸ¨ Code Style: ${{ needs.checkstyle.result }}"
          echo "ğŸ§ª Unit Tests: ${{ needs.unit-tests.result }}"
          echo "ğŸ”— Integration Tests: ${{ needs.integration-tests.result }}"
          echo "================================"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”— Workflow: ${{ github.workflow }}"
          echo "ğŸ“ PR: #${{ github.event.pull_request.number }}"
